# =============================
# ğŸ“¦ Base Image
# =============================
FROM node:22-alpine

# Instala bibliotecas necessÃ¡rias para o Sharp e dependÃªncias nativas
RUN apk update && apk add --no-cache \
  build-base \
  gcc \
  autoconf \
  automake \
  zlib-dev \
  libpng-dev \
  nasm \
  bash \
  vips-dev \
  git

# =============================
# âš™ï¸ VariÃ¡veis de ambiente
# =============================
ARG NODE_ENV=development
ENV NODE_ENV=${NODE_ENV}
ENV HOST=0.0.0.0
ENV PORT=1337

# =============================
# ğŸ“ Instala dependÃªncias
# =============================
WORKDIR /opt/
COPY package.json package-lock.json ./
RUN npm install -g node-gyp
RUN npm config set fetch-retry-maxtimeout 600000 -g && npm install --legacy-peer-deps
ENV PATH=/opt/node_modules/.bin:$PATH

# =============================
# ğŸ“ Copia o cÃ³digo da aplicaÃ§Ã£o
# =============================
WORKDIR /opt/app
COPY . .

# Copia o arquivo .env (muito importante)
COPY .env .env

# Ajusta permissÃµes
RUN chown -R node:node /opt/app
USER node

# Porta exposta
EXPOSE 1337

# =============================
# ğŸš€ Comando padrÃ£o
# =============================
CMD ["npm", "run", "develop"]
